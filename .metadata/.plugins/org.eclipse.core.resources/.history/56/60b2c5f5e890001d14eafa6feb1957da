package com.java.aopdemo.aspect;

import java.util.List;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.After;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.AfterThrowing;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;
import com.java.aopdemo.Account;

@Aspect
@Component
@Order(1)
public class MyDemoLoggingAspect { 
  private Loo
  @Around("execution(* com.java.aopdemo.service.FortuneService.getDailyFortune(..))")
  public Object aroundGetDailyFortune(ProceedingJoinPoint theJoinPoint) throws Throwable {
    String method = theJoinPoint.getSignature().toShortString();
    System.out.println("Executing @Around Advice on method : "+method);
    long begin = System.currentTimeMillis();
    Object result = theJoinPoint.proceed();
    long duration = System.currentTimeMillis() - begin;
    System.out.println("Duration = "+duration/1000.0+" Seconds");
    return result;
  }
  @After("execution(* com.java.aopdemo.dao.AccountDAO.findAccounts(..))")
  public void afterFinallyFindAccountsAdvice(JoinPoint theJoinPoint) {
    String method = theJoinPoint.getSignature().toShortString();
    System.out.println("Running @After Advice on method : "+method);
    System.out.println("Runing any way");
  }
  @AfterThrowing(
      pointcut = "execution(* com.java.aopdemo.dao.AccountDAO.findAccounts(..))",
      throwing = "Exc")
  public void afterThrowingFindAccountsAdvice(JoinPoint theJoinPoint, Throwable Exc) {
    String method = theJoinPoint.getSignature().toShortString();
    System.out.println("Executing @AfterThrowing on method :"+ method);
    System.out.println("The Exception is ========> "+Exc);
  }
  @AfterReturning(pointcut = "execution(* com.java.aopdemo.dao.AccountDAO.findAccounts(..))",
      returning = "result")
  public void afterReturningFindAccounts(JoinPoint theJoinPoint, List<Account> result) {
    String method = theJoinPoint.getSignature().toShortString();
    System.out.println("Executing @AfterReturning on method : "+method);
    System.out.println("Result : "+result);
    // Modifying data for visualization
    convertAccountNamesToUppercase(result);
  }
  private void convertAccountNamesToUppercase(List<Account> result) {
    for(Account acc : result) {
      acc.setName(acc.getName().toUpperCase());
      acc.setLevel(acc.getLevel().toUpperCase());
    }  
  }
  @Before("com.java.aopdemo.aspect.JavaAopExpressions.forDAOPackeageExceptGetAndSet()")
  private void beforeAddAccountAdvice(JoinPoint theJoinPoint) {
    System.out.println("1 ------------> Executing @Before Advice on addAccount()");
    MethodSignature methodSig = (MethodSignature) theJoinPoint.getSignature();
    System.out.println(methodSig);
    Object[] args = theJoinPoint.getArgs();
    for(Object arg : args) {
      System.out.println(arg);
      if(arg instanceof Account) {
        //Downcast and print account related stuff
        Account theAccount = (Account) arg;
        System.out.println(theAccount.getName()+"  "+theAccount.getLevel());
      }
    }
  }

}
